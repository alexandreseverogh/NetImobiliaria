-- ============================================================
-- CORREÇÃO CRÍTICA DE SEGURANÇA - VERSÃO 2
-- ============================================================
-- PROBLEMA: Usuários sem permissões tinham acesso a TODAS as
-- funcionalidades administrativas
-- 
-- SOLUÇÃO: NEGAR acesso por padrão - só permitir com permissão
-- explícita
-- ============================================================

CREATE OR REPLACE FUNCTION get_sidebar_menu_for_user(p_user_id uuid)
RETURNS TABLE(id integer, parent_id integer, name character varying, icon_name character varying, url character varying, order_index integer, has_permission boolean)
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
    RETURN QUERY
    SELECT 
        smi.id,
        smi.parent_id,
        smi.name,
        smi.icon_name,
        smi.url,
        smi.order_index,
        CASE
            -- Item com feature_id específica: verificar permissão específica
            WHEN smi.feature_id IS NOT NULL THEN
                EXISTS (
                    SELECT 1 
                    FROM role_permissions rp
                    JOIN user_role_assignments ura ON rp.role_id = ura.role_id
                    JOIN permissions p ON rp.permission_id = p.id
                    WHERE ura.user_id = p_user_id
                    AND p.feature_id = smi.feature_id
                )
            -- Item sem feature_id: NEGAR acesso por padrão
            -- Só permitir se explicitamente configurado
            WHEN smi.feature_id IS NULL THEN false
            ELSE false
        END as has_permission
    FROM sidebar_menu_items smi
    WHERE smi.is_active = true
    ORDER BY smi.order_index;
END;
$$;

-- ============================================================
-- VERIFICAÇÃO IMEDIATA
-- ============================================================
-- Testar com usuário sem permissões
-- ============================================================

COMMENT ON FUNCTION get_sidebar_menu_for_user(uuid) IS 'CORREÇÃO CRÍTICA V2: Função agora NEGA acesso por padrão - só permite com permissão explícita';
