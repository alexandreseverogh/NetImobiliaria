-- ============================================================
-- CORREÇÃO CRÍTICA DE SEGURANÇA - VULNERABILIDADE GRAVE
-- ============================================================
-- PROBLEMA: Função get_sidebar_menu_for_user estava permitindo
-- acesso a TODOS os itens sem feature_id associado
-- 
-- IMPACTO: Usuários sem permissões tinham acesso a TODAS as
-- funcionalidades administrativas
-- 
-- SOLUÇÃO: Alterar lógica para ser mais restritiva
-- ============================================================

-- BACKUP DA FUNÇÃO ATUAL (para rollback se necessário)
CREATE OR REPLACE FUNCTION get_sidebar_menu_for_user_backup(p_user_id uuid)
RETURNS TABLE(id integer, parent_id integer, name character varying, icon_name character varying, url character varying, order_index integer, has_permission boolean)
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
    RETURN QUERY
    SELECT 
        smi.id,
        smi.parent_id,
        smi.name,
        smi.icon_name,
        smi.url,
        smi.order_index,
        CASE
            WHEN smi.feature_id IS NULL THEN true -- ← VULNERABILIDADE AQUI!
            WHEN EXISTS (
                SELECT 1 
                FROM role_permissions rp
                JOIN user_role_assignments ura ON rp.role_id = ura.role_id
                JOIN permissions p ON rp.permission_id = p.id
                WHERE ura.user_id = p_user_id
                AND p.feature_id = smi.feature_id
            ) THEN true
            ELSE false
        END as has_permission
    FROM sidebar_menu_items smi
    WHERE smi.is_active = true
    ORDER BY smi.order_index;
END;
$$;

-- ============================================================
-- NOVA FUNÇÃO SEGURA
-- ============================================================
-- REGRA: Só exibe itens se:
-- 1. Usuário tem permissão específica para a feature, OU
-- 2. Item não tem feature_id E usuário tem permissão "admin" geral
-- ============================================================

CREATE OR REPLACE FUNCTION get_sidebar_menu_for_user(p_user_id uuid)
RETURNS TABLE(id integer, parent_id integer, name character varying, icon_name character varying, url character varying, order_index integer, has_permission boolean)
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
    RETURN QUERY
    SELECT 
        smi.id,
        smi.parent_id,
        smi.name,
        smi.icon_name,
        smi.url,
        smi.order_index,
        CASE
            -- Item com feature_id específica: verificar permissão específica
            WHEN smi.feature_id IS NOT NULL THEN
                EXISTS (
                    SELECT 1 
                    FROM role_permissions rp
                    JOIN user_role_assignments ura ON rp.role_id = ura.role_id
                    JOIN permissions p ON rp.permission_id = p.id
                    WHERE ura.user_id = p_user_id
                    AND p.feature_id = smi.feature_id
                )
            -- Item sem feature_id: só permitir se usuário tem permissão admin geral
            WHEN smi.feature_id IS NULL THEN
                EXISTS (
                    SELECT 1 
                    FROM role_permissions rp
                    JOIN user_role_assignments ura ON rp.role_id = ura.role_id
                    JOIN permissions p ON rp.permission_id = p.id
                    JOIN system_features sf ON p.feature_id = sf.id
                    WHERE ura.user_id = p_user_id
                    AND sf.name = 'admin' -- Permissão admin geral
                )
            ELSE false
        END as has_permission
    FROM sidebar_menu_items smi
    WHERE smi.is_active = true
    ORDER BY smi.order_index;
END;
$$;

-- ============================================================
-- VERIFICAÇÃO DE SEGURANÇA
-- ============================================================
-- Testar com usuário sem permissões
-- ============================================================

-- Comentário de segurança
COMMENT ON FUNCTION get_sidebar_menu_for_user(uuid) IS 'CORREÇÃO CRÍTICA: Função agora é restritiva - só exibe itens com permissão específica ou admin geral';

-- ============================================================
-- PRÓXIMOS PASSOS NECESSÁRIOS:
-- ============================================================
-- 1. Associar TODOS os itens da sidebar a features específicas
-- 2. Criar permissão "admin" geral para administradores
-- 3. Testar com usuários de diferentes níveis
-- ============================================================
